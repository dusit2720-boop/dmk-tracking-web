<!DOCTYPE html>
<html lang="th" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DMK ระบบตรวจสอบการขาย Cash Card</title>
    <!-- 1. Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 2. Google Fonts (Inter & Sarabun) -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Sarabun:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- 3. Firebase SDKs -->
    <script type="module">
        // Import Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, setPersistence, browserSessionPersistence, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, updateDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Firebase Config (ที่คุณให้มา) ---
        const firebaseConfig = {
          apiKey: "AIzaSyCl-1kUPk7YP0AZoKqVs9d_Z7vWeXytQnk",
          authDomain: "dmk-cashcard-2025.firebaseapp.com",
          projectId: "dmk-cashcard-2025",
          storageBucket: "dmk-cashcard-2025.firebasestorage.app",
          messagingSenderId: "769501660953",
          appId: "1:769501660953:web:05daed34647bd3abd3e788",
          measurementId: "G-BFE7G2G7C3"
        };
        
        // นี่คือ APP_ID ที่เราตกลงกันใน App Script (ต้องตรงกัน)
        const APP_ID = "dmk-cashcard-2025-app";
        
        // --- Initialize Firebase ---
        let app, auth, db;
        let currentUserId = null; // นี่จะเก็บ "ID พนักงาน" (เช่น 12345)
        let unsubscribeIncome = null; // ตัวแปรสำหรับหยุดฟังข้อมูล
        
        try {
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
            // ตั้งค่าให้ Login อยู่ใน Session นี้เท่านั้น (ปิดเบราว์เซอร์ = Logout)
            await setPersistence(auth, browserSessionPersistence);
        } catch (e) {
            console.error("Firebase Init Error:", e);
            showModal("เกิดข้อผิดพลาดในการเชื่อมต่อฐานข้อมูลหลัก");
        }

        // --- DOM Elements ---
        const loginSection = document.getElementById('login-section');
        const dataSection = document.getElementById('data-section');
        const loadingOverlay = document.getElementById('loading-overlay');
        const modal = document.getElementById('modal');
        const modalMessage = document.getElementById('modal-message');
        const modalCloseButton = document.getElementById('modal-close');
        
        const employeeIdInput = document.getElementById('employee-id');
        const passwordInput = document.getElementById('password');
        const loginButton = document.getElementById('login-button');
        const logoutButton = document.getElementById('logout-button');
        
        const welcomeMessage = document.getElementById('welcome-message');
        const salesDataTable = document.getElementById('sales-data-table');
        const totalIdSaleEl = document.getElementById('total-id-sale');
        const totalItemsEl = document.getElementById('total-items');
        
        const confirmationSection = document.getElementById('confirmation-section');
        const confirmButton = document.getElementById('confirm-button');
        const confirmationStatus = document.getElementById('confirmation-status');

        // --- UI Helper Functions ---
        function showLoading(message = "กำลังโหลด...") {
            document.getElementById('loading-message').textContent = message;
            loadingOverlay.classList.remove('hidden');
        }
        function hideLoading() {
            loadingOverlay.classList.add('hidden');
        }
        function showModal(message) {
            modalMessage.textContent = message;
            modal.classList.remove('hidden');
        }
        modalCloseButton.addEventListener('click', () => modal.classList.add('hidden'));

        // --- Core Functions ---

        /**
         * 1. ตรวจสอบสถานะการ Login
         */
        onAuthStateChanged(auth, (user) => {
            if (user) {
                // --- ผู้ใช้ Login เข้าระบบแล้ว ---
                const employeeIdFromEmail = user.email.split('@')[0];
                currentUserId = employeeIdFromEmail; 
                
                loginSection.classList.add('hidden');
                dataSection.classList.remove('hidden');
                
                listenToIncomeData(currentUserId);
                
            } else {
                // --- ผู้ใช้ยังไม่ได้ Login หรือ Logout ออกไปแล้ว ---
                currentUserId = null;
                loginSection.classList.remove('hidden');
                dataSection.classList.add('hidden');
                hideLoading();
                
                if (unsubscribeIncome) {
                    unsubscribeIncome();
                    unsubscribeIncome = null;
                }
                
                welcomeMessage.textContent = "สวัสดี,";
                salesDataTable.innerHTML = "";
                totalIdSaleEl.textContent = "-";
                totalItemsEl.textContent = "-";
                confirmationStatus.classList.add('hidden');
                confirmButton.classList.remove('hidden');
            }
        });

        /**
         * 2. จัดการการ Login (ใช้ Email/Password ของ Firebase)
         */
        loginButton.addEventListener('click', async () => {
            const employeeId = employeeIdInput.value.trim();
            const password = passwordInput.value.trim();
            
            if (!employeeId || !password) {
                // *** START OF CHANGE (Text Edit) ***
                showModal("กรุณากรอก ID พนักงาน และ รหัสผ่าน (ปีเกิด ค.ศ.+เดือนเกิด)");
                // *** END OF CHANGE ***
                return;
            }

            showLoading("กำลังตรวจสอบข้อมูล...");

            try {
                const email = `${employeeId}@company.demo`;
                const userCredential = await signInWithEmailAndPassword(auth, email, password);
                
                hideLoading();
                showModal("เข้าสู่ระบบสำเร็จ!");
                setTimeout(() => modal.classList.add('hidden'), 1500);

            } catch (error) {
                hideLoading();
                console.error("Login Error:", error.code, error.message);
                
                if (error.code === 'auth/invalid-credential' || 
                    error.code === 'auth/wrong-password' || 
                    error.code === 'auth/user-not-found' ||
                    error.code === 'auth/invalid-email') 
                {
                    showModal("ID พนักงาน หรือ รหัสผ่านไม่ถูกต้อง");
                } else {
                    showModal("เกิดข้อผิดพลาดในการ Login: " + error.code);
                }
            }
        });

        /**
         * 3. จัดการการ Logout
         */
        logoutButton.addEventListener('click', async () => {
            showLoading("กำลังออกจากระบบ...");
            try {
                await signOut(auth);
            } catch (error) {
                console.error("Logout Error:", error);
                hideLoading();
                showModal("เกิดข้อผิดพลาดในการออกจากระบบ");
            }
        });

        /**
         * 4. "ฟัง" ข้อมูลจาก Firestore
         */
        function listenToIncomeData(userId) {
            showLoading("กำลังดึงข้อมูล...");
            const docPath = `artifacts/${APP_ID}/salesData/${userId}`;
            const incomeDocRef = doc(db, docPath);

            unsubscribeIncome = onSnapshot(incomeDocRef, (docSnap) => {
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    displaySalesData(data); 
                    updateConfirmationUI(data); 
                } else {
                    console.error("ไม่พบข้อมูล", docPath);
                    showModal("ไม่พบข้อมูลการขายของคุณ กรุณาติดต่อ Admin เพื่อซิงค์ข้อมูล");
                    signOut(auth); 
                }
                hideLoading();
            }, (error) => {
                console.error("Firestore Read Error:", error);
                hideLoading();
                if (error.code === 'permission-denied') {
                     showModal("คุณไม่มีสิทธิ์เข้าถึงข้อมูลนี้ กรุณาตรวจสอบ Security Rules ใน Firebase");
                     signOut(auth);
                } else {
                    showModal("เกิดข้อผิดพลาดในการดึงข้อมูล");
                }
            });
        }

        /**
         * 5. แสดงผลข้อมูลบนหน้าจอ
         * (อัปเดตให้อ่าน Array และแสดงผลเป็นเลขจำนวนเต็ม)
         */
        function displaySalesData(data) {
            welcomeMessage.textContent = `สวัสดี, คุณ ${data.name || data.id}`;
            salesDataTable.innerHTML = "";

            // วน Loop Array (ที่ App Script ซิงค์มาแบบเรียงลำดับ)
            if (data.salesMonths && Array.isArray(data.salesMonths)) {
                
                for (const monthData of data.salesMonths) {
                    // monthData จะเป็น { month: "ธันวาคม 2567", value: 123 }
                    const month = monthData.month;
                    const value = monthData.value;
                    
                    if (!month || month.trim() === "") continue; 
                    
                    const row = document.createElement('tr');
                    row.className = "border-b border-gray-200";
                    
                    const cellMonth = document.createElement('td');
                    cellMonth.className = "py-3 px-4 text-gray-700";
                    cellMonth.textContent = month;
                    
                    const cellValue = document.createElement('td');
                    cellValue.className = "py-3 px-4 text-gray-900 font-medium text-right";
                    
                    // แสดงผลเป็นเลขจำนวนเต็ม (ไม่มีทศนิยม)
                    cellValue.textContent = value.toLocaleString('en-US'); // (เช่น 123)
                    
                    row.appendChild(cellMonth);
                    row.appendChild(cellValue);
                    salesDataTable.appendChild(row);
                }
            }
            
            
            const totalSale = data.totalFromIdSale || 0;
            const totalItems = data.totalItems || 0;
            
            // แสดงผลเป็นเลขจำนวนเต็ม (ไม่มีทศนิยม)
            totalIdSaleEl.textContent = totalSale.toLocaleString('en-US');
            
            totalItemsEl.textContent = totalItems.toLocaleString('en-US');
        }

        /**
         * 6. อัปเดต UI ส่วนการยืนยัน
         */
        function updateConfirmationUI(data) {
            if (data.confirmedAt) {
                confirmButton.classList.add('hidden'); 
                confirmationStatus.classList.remove('hidden');
                
                const confirmedDate = data.confirmedAt.toDate();
                confirmationStatus.textContent = `ยืนยันข้อมูลแล้ว เมื่อ: ${confirmedDate.toLocaleString('th-TH')}`;
            } else {
                confirmButton.classList.remove('hidden');
                confirmationStatus.classList.add('hidden');
            }
        }


        /**
         * 7. จัดการการกดยืนยัน
         */
        confirmButton.addEventListener('click', async () => {
            if (!currentUserId) {
                showModal("Error: ไม่พบ User ID");
                return;
            }

            showLoading("กำลังบันทึกการยืนยัน...");

            const docPath = `artifacts/${APP_ID}/salesData/${currentUserId}`;
            const incomeDocRef = doc(db, docPath);

            try {
                await updateDoc(incomeDocRef, {
                    confirmedAt: serverTimestamp() 
                });
                
                hideLoading();
                showModal("บันทึกการยืนยันสำเร็จ!");
                setTimeout(() => modal.classList.add('hidden'), 1500);

            } catch (error) {
                hideLoading();
                console.error("Confirm Error:", error);
                showModal("เกิดข้อผิดพลาดในการบันทึกการยืนยัน");
            }
        });

    </script>
    <style>
        /* ใช้ฟอนต์ Sarabun สำหรับเนื้อหาไทย และ Inter สำหรับ UI */
        body {
            font-family: 'Sarabun', 'Inter', sans-serif;
        }
        h1, h2, h3, button, input {
            font-family: 'Inter', 'Sarabun', sans-serif;
        }
        #loading-overlay, #modal {
            transition: opacity 0.3s ease-in-out;
        }
    </style>
</head>
<body class="bg-gray-100 h-full flex items-center justify-center">

    <!-- 1. Login Section (ส่วน Login) -->
    <section id="login-section" class="w-full max-w-md mx-auto p-4">
        <div class="bg-white shadow-xl rounded-lg p-8">
            <h1 class="text-2xl font-bold text-center text-gray-800 mb-2">DMK</h1>
            <h2 class="text-lg font-semibold text-center text-gray-600 mb-6">ระบบตรวจสอบการขาย Cash Card</h2>
            
            <div class="space-y-4">
                <div>
                    <label for="employee-id" class="block text-sm font-medium text-gray-700">ID พนักงาน</label>
                    <input type="text" id="employee-id" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" placeholder="เช่น 12345">
                </div>
                
                <div>
                    <!-- *** START OF CHANGE (Text Edit) *** -->
                    <label for="password" class="block text-sm font-medium text-gray-700">รหัสผ่าน (ปีเกิดใช้ ค.ศ.+เดือนเกิด เช่น 198701)</label>
                    <input type="password" id="password" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" placeholder="เช่น 198701">
                    <!-- *** END OF CHANGE *** -->
                </div>
                
                <button id="login-button" class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                    เข้าสู่ระบบ
                </button>
            </div>
        </div>
    </section>

    <!-- 2. Data Section (ส่วนแสดงข้อมูล) -->
    <section id="data-section" class="w-full max-w-2xl mx-auto p-4 hidden">
        <div class="bg-white shadow-xl rounded-lg overflow-hidden">
            <!-- Header -->
            <div class="p-6 border-b border-gray-200">
                <div class="flex justify-between items-center">
                    <div>
                        <h1 class="text-2xl font-bold text-gray-800">DMK Cash Card</h1>
                        <p id="welcome-message" class="text-md text-gray-600">สวัสดี, คุณ ...</p>
                    </div>
                    <button id="logout-button" class="text-sm font-medium text-red-600 hover:text-red-800 focus:outline-none">
                        ออกจากระบบ
                    </button>
                </div>
            </div>
            
            <!-- Sales Data Table -->
            <div class="p-6">
                <!-- (Change 1) -->
                <h2 class="text-lg font-semibold text-gray-700 mb-4">ข้อมูลยอดขาย Cash card ของคุณ</h2>
                
                <div class="border border-gray-200 rounded-lg overflow-hidden">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="py-3 px-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">เดือน</th>
                                <!-- (Change 2) -->
                                <th class="py-3 px-4 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">ยอดขาย (รายการ)</th>
                            </tr>
                        </thead>
                        <tbody id="sales-data-table" class="bg-white divide-y divide-gray-200">
                            <!-- แถวข้อมูลจะถูกสร้างโดย JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>
            
            <!-- Totals -->
            <div class="p-6 bg-gray-50 border-t border-gray-200 grid grid-cols-1 md:grid-cols-2 gap-4">
                <!-- (Change 4 & Last Edit) -->
                <div class="bg-white p-4 rounded-lg shadow-inner border border-gray-200">
                    <p class="text-sm font-medium text-gray-500">ข้อมูลจากช่อง Sales Staff ในใบเสร็จ</p>
                    <p class="text-2xl font-bold text-gray-900">
                        <span id="total-id-sale">0</span>
                        <span class="text-lg font-medium text-gray-600"> รายการ</span>
                    </p>
                </div>
                
                <div class="bg-white p-4 rounded-lg shadow-inner border border-gray-200">
                    <p class="text-sm font-medium text-gray-500">ยอดรวมจำนวนรายการ</p>
                    <p class="text-2xl font-bold text-gray-900">
                        <span id="total-items">0</span>
                        <span class="text-lg font-medium text-gray-600"> รายการ</span>
                    </p>
                </div>
            </div>

            <!-- Confirmation Section -->
            <div id="confirmation-section" class="p-6 border-t border-gray-200">
                <h2 class="text-lg font-semibold text-gray-700 mb-3">การยืนยันข้อมูล</h2>
                <p class="text-sm text-gray-600 mb-4">กรุณาตรวจสอบข้อมูลยอดขายข้างต้นให้ถูกต้อง หากข้อมูลถูกต้องครบถ้วน กรุณากดปุ่ม "ยืนยันข้อมูล" เพื่อบันทึกการตรวจสอบ</p>
                
                <!-- ปุ่มยืนยัน -->
                <button id="confirm-button" class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500">
                    คลิกเพื่อยืนยันข้อมูล
                </button>
                
                <!-- สถานะการยืนยัน (จะแสดงหลังกดยืนยันแล้ว) -->
                <div id="confirmation-status" class="hidden text-center p-3 bg-green-50 border border-green-200 rounded-md">
                    <p class="font-medium text-green-700">ยืนยันข้อมูลแล้ว เมื่อ: ...</p>
                </div>
            </div>

        </div>
    </section>

    <!-- 3. Loading Overlay (ตัวหมุน) -->
    <div id="loading-overlay" class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50">
        <div class="flex flex-col items-center">
            <!-- Spinner -->
            <svg class="animate-spin -ml-1 mr-3 h-10 w-10 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <p id="loading-message" class="text-white text-lg mt-4">กำลังโหลด...</p>
        </div>
    </div>
    
    <!-- 4. Modal (หน้าต่างแจ้งเตือน) -->
    <div id="modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50">
        <div class="bg-white rounded-lg shadow-xl p-6 w-11/12 max-w-sm mx-auto">
            <p id="modal-message" class="text-center text-gray-700">ข้อความแจ้งเตือน</p>
            <button id="modal-close" class="mt-4 w-full bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500">
                ตกลง
            </button>
        </div>
    </div>

</body>
</html>

