<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <!-- FIX: รองรับมือถือ -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DMK ระบบตรวจสอบค่าเสียหายและรายได้</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Sarabun', sans-serif; }
        /* Animation */
        .loader {
            border-top-color: #3b82f6;
            -webkit-animation: spinner 1.5s linear infinite;
            animation: spinner 1.5s linear infinite;
        }
        @keyframes spinner { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-gray-100 min-h-screen text-gray-800">

    <!-- 1. LOGIN PAGE -->
    <!-- ใช้ class 'hidden' ของ Tailwind เพื่อซ่อน/แสดง -->
    <div id="login-page" class="min-h-screen flex flex-col items-center justify-center p-4">
        <div class="bg-white p-8 rounded-xl shadow-lg w-full max-w-md border border-gray-200">
            <div class="text-center mb-8">
                <h1 class="text-2xl font-bold text-gray-800">ระบบตรวจสอบ</h1>
                <p class="text-gray-500 text-sm mt-1">DMK Tracking</p>
            </div>
            
            <form id="login-form" class="space-y-5">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">ID พนักงาน</label>
                    <input type="text" id="login-id" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" placeholder="เช่น 12345" required>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">รหัสผ่าน</label>
                    <input type="password" id="login-pass" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" placeholder="กรอกรหัสผ่าน" required>
                    <p class="text-xs text-gray-400 mt-1">*ระบบเติม 0 ให้อัตโนมัติถ้ารหัสสั้น</p>
                </div>
                <button type="submit" id="btn-login-submit" class="w-full bg-blue-600 text-white p-3 rounded-lg font-bold hover:bg-blue-700 transition shadow-md">
                    เข้าสู่ระบบ
                </button>
            </form>
            
            <div id="login-error" class="mt-4 p-3 bg-red-50 text-red-600 text-sm rounded-lg hidden text-center border border-red-100"></div>
        </div>
    </div>

    <!-- 2. DASHBOARD PAGE -->
    <div id="dashboard-page" class="hidden pb-20">
        <!-- Navbar -->
        <nav class="bg-blue-700 text-white p-4 shadow-lg sticky top-0 z-10">
            <div class="container mx-auto max-w-2xl flex justify-between items-center">
                <div>
                    <h1 class="font-bold text-lg">DMK Tracking</h1>
                    <div class="text-xs text-blue-200 mt-0.5" id="user-info">Loading...</div>
                </div>
                <div class="flex gap-2">
                    <button id="btn-change-pass" class="bg-white/20 hover:bg-white/30 px-3 py-1 rounded text-sm transition">รหัสผ่าน</button>
                    <button id="btn-logout" class="bg-red-500 hover:bg-red-600 px-3 py-1 rounded text-sm transition">ออก</button>
                </div>
            </div>
        </nav>

        <!-- Content -->
        <div class="container mx-auto p-4 max-w-2xl mt-4">
            <!-- Date Filter -->
            <div class="bg-white p-4 rounded-xl shadow-sm mb-6 flex flex-col sm:flex-row items-center gap-3">
                <label class="font-bold text-gray-700 whitespace-nowrap">รอบเดือนบัญชี:</label>
                <input type="month" id="month-picker" class="border-gray-300 border p-2 rounded-lg w-full sm:w-auto flex-grow bg-gray-50 font-medium">
            </div>

            <!-- Data Content -->
            <div id="data-content" class="space-y-4 hidden">
                <div class="bg-white p-5 rounded-xl shadow-sm border-l-4 border-red-500">
                    <h3 class="text-gray-500 text-xs font-bold uppercase">1.1 ค่าเสียหาย Short Cash</h3>
                    <p class="text-2xl font-bold text-gray-800 mt-1"><span id="val-short-cash">0</span> <span class="text-sm text-gray-400 font-normal">บาท</span></p>
                </div>
                <div class="bg-white p-5 rounded-xl shadow-sm border-l-4 border-orange-500">
                    <h3 class="text-gray-500 text-xs font-bold uppercase">1.2 ค่าเสียหาย Short Credit</h3>
                    <p class="text-2xl font-bold text-gray-800 mt-1"><span id="val-short-credit">0</span> <span class="text-sm text-gray-400 font-normal">บาท</span></p>
                </div>
                <div class="bg-white p-5 rounded-xl shadow-sm border-l-4 border-green-500">
                    <h3 class="text-gray-500 text-xs font-bold uppercase">2. ยอดเงินคืน (Short Credit)</h3>
                    <p class="text-2xl font-bold text-green-600 mt-1"><span id="val-refund">0</span> <span class="text-sm text-gray-400 font-normal">บาท</span></p>
                    <div class="mt-3 pt-3 border-t text-sm flex justify-between">
                        <span class="text-gray-500">คงเหลือที่ต้องชำระ:</span>
                        <span class="font-bold text-gray-800" id="val-balance">0 บาท</span>
                    </div>
                </div>
            </div>
            
            <!-- Loading -->
            <div id="dash-loading" class="text-center py-12 hidden">
                <div class="loader ease-linear rounded-full border-4 border-t-4 border-gray-200 h-10 w-10 mx-auto mb-4"></div>
                <p class="text-gray-500 text-sm">กำลังโหลดข้อมูล...</p>
            </div>
            
            <!-- No Data -->
            <div id="no-data" class="text-center py-12 hidden bg-white rounded-xl border-2 border-dashed border-gray-200">
                <p class="text-gray-500 font-medium">ไม่พบข้อมูลของเดือนนี้</p>
                <p class="text-gray-400 text-xs mt-2 font-mono bg-gray-100 inline-block px-2 py-1 rounded" id="debug-path">Path: ...</p>
                <p class="text-gray-400 text-xs mt-2">กรุณาตรวจสอบว่า Admin ได้กดซิงค์ข้อมูลแล้ว</p>
            </div>
        </div>
    </div>

    <!-- 3. Change Password Modal -->
    <div id="pass-modal" class="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center p-4 hidden z-50">
        <div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-sm">
            <h2 class="text-xl font-bold mb-4">เปลี่ยนรหัสผ่าน</h2>
            <form id="pass-form" class="space-y-4">
                <input type="password" id="new-pass" class="w-full p-3 border rounded-lg" required minlength="6" placeholder="รหัสผ่านใหม่">
                <div class="flex justify-end gap-2">
                    <button type="button" id="btn-close-modal" class="px-4 py-2 text-gray-600 bg-gray-100 rounded-lg">ยกเลิก</button>
                    <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-lg">บันทึก</button>
                </div>
            </form>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged, updatePassword } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCl-1kUPk7YP0AZoKqVs9d_Z7vWeXytQnk",
            authDomain: "dmk-cashcard-2025.firebaseapp.com",
            projectId: "dmk-cashcard-2025",
            storageBucket: "dmk-cashcard-2025.firebasestorage.app",
            messagingSenderId: "769501660953",
            appId: "1:769501660953:web:05daed34647bd3abd3e788",
            measurementId: "G-BFE7G2G7C3"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const APP_ID = "dmk-cashcard-2025-app";

        let currentUser = null;
        let unsubscribeData = null;

        // --- AUTH STATE CHANGE ---
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                // User Logged In
                currentUser = user;
                
                // FIX: ใช้ classList.add/remove('hidden') เพื่อความชัวร์
                document.getElementById('login-page').classList.add('hidden');
                document.getElementById('dashboard-page').classList.remove('hidden');
                
                // Default Month
                if (!document.getElementById('month-picker').value) {
                    document.getElementById('month-picker').value = new Date().toISOString().slice(0, 7);
                }
                
                // Get Name
                const empId = user.email.split('@')[0];
                try {
                    const userSnap = await getDoc(doc(db, `artifacts/${APP_ID}/users/${empId}`));
                    const name = userSnap.exists() ? userSnap.data().name : empId;
                    document.getElementById('user-info').textContent = `${name} (${empId})`;
                } catch (e) {
                    document.getElementById('user-info').textContent = empId;
                }

                loadData(document.getElementById('month-picker').value);

            } else {
                // User Logged Out
                currentUser = null;
                document.getElementById('login-page').classList.remove('hidden');
                document.getElementById('dashboard-page').classList.add('hidden');
                
                if(unsubscribeData) unsubscribeData();
                document.getElementById('login-form').reset();
                
                const btn = document.getElementById('btn-login-submit');
                btn.disabled = false;
                btn.innerText = "เข้าสู่ระบบ";
                document.getElementById('login-error').classList.add('hidden');
            }
        });

        // --- DATA LOADING ---
        function loadData(yearMonth) { 
            if (!yearMonth) return;
            if (unsubscribeData) unsubscribeData();
            
            const empId = currentUser.email.split('@')[0];
            // Path Pattern: records/YYYY-MM
            const docPath = `artifacts/${APP_ID}/users/${empId}/records/${yearMonth}`;
            
            // Update Debug Info
            document.getElementById('debug-path').innerText = `Checking: .../users/${empId}/records/${yearMonth}`;

            document.getElementById('dash-loading').classList.remove('hidden');
            document.getElementById('data-content').classList.add('hidden');
            document.getElementById('no-data').classList.add('hidden');

            unsubscribeData = onSnapshot(doc(db, docPath), (docSnap) => {
                document.getElementById('dash-loading').classList.add('hidden');
                
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    document.getElementById('data-content').classList.remove('hidden');
                    
                    const sc = data.shortCash || 0;
                    const scr = data.shortCredit || 0;
                    const ref = data.refund || 0;
                    
                    updateVal('val-short-cash', sc);
                    updateVal('val-short-credit', scr);
                    updateVal('val-refund', ref);
                    
                    const balance = scr - ref;
                    const balEl = document.getElementById('val-balance');
                    balEl.textContent = balance.toLocaleString('th-TH', {minimumFractionDigits: 0}) + ' บาท';
                    balEl.className = balance > 0 ? "font-bold text-lg text-red-600" : "font-bold text-lg text-green-600";
                } else {
                    document.getElementById('no-data').classList.remove('hidden');
                }
            }, (error) => {
                console.error(error);
                document.getElementById('dash-loading').classList.add('hidden');
                alert("Error: " + error.message);
            });
        }

        function updateVal(id, num) {
            document.getElementById(id).textContent = num.toLocaleString('th-TH', {minimumFractionDigits: 0});
        }

        // --- EVENTS ---
        document.getElementById('login-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = document.getElementById('btn-login-submit');
            const errEl = document.getElementById('login-error');
            
            btn.disabled = true;
            btn.innerText = "กำลังตรวจสอบ...";
            errEl.classList.add('hidden');

            const id = document.getElementById('login-id').value.trim();
            let pass = document.getElementById('login-pass').value.trim();
            
            if (pass.length > 0 && pass.length < 6) {
                while (pass.length < 6) pass += '0';
            }

            try {
                await signInWithEmailAndPassword(auth, `${id}@company.demo`, pass);
            } catch (err) {
                btn.disabled = false;
                btn.innerText = "เข้าสู่ระบบ";
                errEl.classList.remove('hidden');
                if (err.code === 'auth/invalid-credential' || err.code === 'auth/wrong-password') {
                    errEl.textContent = "ID หรือ รหัสผ่านไม่ถูกต้อง";
                } else {
                    errEl.textContent = "Error: " + err.code;
                }
            }
        });

        document.getElementById('btn-logout').addEventListener('click', () => {
            if(confirm('ต้องการออกจากระบบ?')) signOut(auth);
        });

        document.getElementById('month-picker').addEventListener('change', (e) => loadData(e.target.value));

        // Password Modal
        const modal = document.getElementById('pass-modal');
        document.getElementById('btn-change-pass').addEventListener('click', () => modal.classList.remove('hidden'));
        document.getElementById('btn-close-modal').addEventListener('click', () => modal.classList.add('hidden'));
        
        document.getElementById('pass-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            try {
                await updatePassword(currentUser, document.getElementById('new-pass').value);
                alert('เปลี่ยนรหัสผ่านสำเร็จ! กรุณาเข้าสู่ระบบใหม่');
                modal.classList.add('hidden');
                document.getElementById('pass-form').reset();
                signOut(auth);
            } catch (err) {
                alert(err.message);
            }
        });
    </script>
</body>
</html>
